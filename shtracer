#!/bin/sh

##
# @defgroup Global variables
# @{

CONFIG_PATH=''
SHTRACER_MODE='NORMAL'
BEFORE_TAG=''
AFTER_TAG=''
EXPORT_JSON='false'
EXPORT_SUMMARY='false'
EXPORT_HTML='false'
SHTRACER_DEBUG='false'
OUTPUT_DIR_DEFAULT_NAME='shtracer_output'
SHTRACER_SEPARATOR="<shtracer_separator>"
CURRENT_DIR="$(pwd)"
SCRIPT_DIR=${SCRIPT_DIR:-$(cd "$(dirname "$0")" && pwd)}

# Export variables used in external scripts
export NODATA_STRING="NONE"
OUTPUT_DIR="${OUTPUT_DIR:-}"
export OUTPUT_DIR
##
# @}
#

##
# @brief  Load helper functions
# @tag    @IMP1.1@ (FROM: @ARC1.2@)
load_functions() {
	_PREVIOUS_DIR="$(pwd)"
	cd "${SCRIPT_DIR}" || error_exit 1 "load_functions" "Cannot change current directory"
	# shellcheck source=scripts/main/shtracer_util.sh
	. "./scripts/main/shtracer_util.sh"
	# shellcheck source=scripts/main/shtracer_func.sh
	. "./scripts/main/shtracer_func.sh"
	cd "${_PREVIOUS_DIR}" || error_exit 1 "load_functions" "Cannot change current directory"
}

##
# @brief  Print usage
# @tag    @IMP1.2@ (FROM: @ARC1.2@)
print_usage() {
	cat <<-USAGE 1>&2
		Usage: shtracer <configfile> [options]

		Options:
		  -c <old_tag> <new_tag>           Change mode: swap or rename trace target tags
		  -v                               Verify mode: detect duplicate or isolated tags
		  -t                               Test mode: execute unit tests
		  --json                           Export traceability data in JSON format
		  --html                           Export a single HTML document to stdout (JSON -> viewer)
		  --summary                        Print traceability summary to stdout (direct links only)
		  --debug                          Keep ${OUTPUT_DIR} (do not auto-delete)
		  -h, --help                       Show this help message

		Examples:
		  1. Normal mode
		     $ ./shtracer ./sample/config.md

		  2. Change mode (swap or rename tags).
		     $ ./shtracer -c old_tag new_tag ./sample/config.md

		  3. Verify mode (check for duplicate or isolated tags).
		     $ ./shtracer -v ./sample/config.md

		  4. Test mode
		     $ ./shtracer -t

		  5. Summary mode
		     $ ./shtracer --summary ./sample/config.md

		  6. HTML mode
		     $ ./shtracer --debug --html ./sample/config.md > ./sample/output.html

		Note:
		  - Arguments can be specified in any order.
		  - Only one option can be used at a time.

		Version:
		  - 0.1.2

	USAGE
	exit 1
}

##
# @brief  Parse arguments with flexible ordering (two-pass algorithm)
# @tag    @IMP1.3@ (FROM: @ARC1.2@)
parse_arguments() {
	# Special case: single argument (help, version, test, or config only)
	if [ "$#" -eq 1 ]; then
		case "$1" in
			-h | -v | --help | --version)
				# Note: -v alone prints usage (backward compatibility)
				# -v with config file activates verify mode
				print_usage
				;;
			-t)
				SHTRACER_MODE='TEST'
				return
				;;
			--json | --html | --summary)
				# These options require a config file
				error_exit 1 "parse_arguments" "Config file required"
				;;
			-*)
				error_exit 1 "parse_arguments" "Invalid argument"
				;;
			*)
				# Single argument: treat as config file
				_config_file="$1"
				SHTRACER_MODE='NORMAL'
				;;
		esac
	else
		# Multi-argument parsing: extract options and config file
		_opt_mode=""
		_opt_flag=""
		_export_flag=""
		_config_file=""
		_change_before=""
		_change_after=""
		_found_option=0

		while [ $# -gt 0 ]; do
			case "$1" in
				-v)
					_found_option=$((_found_option + 1))
					_opt_mode="VERIFY"
					_opt_flag="-v"
					shift
					;;
				-c)
					_found_option=$((_found_option + 1))
					_opt_mode="CHANGE"
					_opt_flag="-c"
					if [ $# -lt 3 ]; then
						error_exit 1 "parse_arguments" "-c requires <before_tag> <after_tag>"
					fi
					shift
					_change_before="$1"
					shift
					_change_after="$1"
					shift
					;;
				--json)
					_found_option=$((_found_option + 1))
					_export_flag="--json"
					shift
					;;
				--html)
					_found_option=$((_found_option + 1))
					_export_flag="--html"
					shift
					;;
				--summary)
					_found_option=$((_found_option + 1))
					_export_flag="--summary"
					shift
					;;
				--debug)
					SHTRACER_DEBUG='true'
					shift
					;;
				-C)
					# Legacy color mode (deprecated, silently ignore)
					shift
					;;
				-*)
					error_exit 1 "parse_arguments" "Invalid option: $1"
					;;
				*)
					# Non-option argument: assume config file
					if [ -z "$_config_file" ]; then
						_config_file="$1"
					else
						error_exit 1 "parse_arguments" "Multiple config files specified"
					fi
					shift
					;;
			esac
		done

		# Validation: reject multiple simultaneous options
		if [ "$_found_option" -gt 1 ]; then
			error_exit 1 "parse_arguments" "Multiple options not supported (use only one of: -v, -c, --json, --html, --summary)"
		fi

		# Validation: mode flags and export flags are mutually exclusive
		if [ -n "$_opt_flag" ] && [ -n "$_export_flag" ]; then
			error_exit 1 "parse_arguments" "Cannot combine $_opt_flag with $_export_flag"
		fi

		# Set mode
		if [ -n "$_opt_mode" ]; then
			SHTRACER_MODE="$_opt_mode"
		else
			SHTRACER_MODE="NORMAL"
		fi

		# Set export flags
		case "$_export_flag" in
			--json)
				EXPORT_JSON='true'
				;;
			--html)
				EXPORT_HTML='true'
				;;
			--summary)
				EXPORT_SUMMARY='true'
				;;
		esac

		# Set change mode tags
		if [ "$SHTRACER_MODE" = "CHANGE" ]; then
			BEFORE_TAG="$_change_before"
			AFTER_TAG="$_change_after"
		fi
	fi

	# Validation: config file required for non-TEST modes
	if [ "$SHTRACER_MODE" != "TEST" ]; then
		if [ -z "$_config_file" ]; then
			error_exit 1 "parse_arguments" "Config file required"
		fi

		# Check if config file exists
		if [ ! -r "$_config_file" ]; then
			error_exit 1 "parse_arguments" "$_config_file does not exist"
		fi

		# Resolve to absolute path
		cd "$CURRENT_DIR" || error_exit 1 "parse_arguments" "Cannot change current directory"
		CONFIG_DIR="$(cd "$(dirname "$_config_file")" && pwd)"
		# OUTPUT_DIR override semantics:
		# - If unset/empty: use default name under CONFIG_DIR
		# - If contains '/': treat as path (absolute, or relative to CONFIG_DIR)
		# - Else: treat as directory name under CONFIG_DIR
		if [ -z "${OUTPUT_DIR:-}" ]; then
			OUTPUT_DIR="${CONFIG_DIR%/}/${OUTPUT_DIR_DEFAULT_NAME}/"
		else
			case "${OUTPUT_DIR}" in
				/*)
					OUTPUT_DIR="${OUTPUT_DIR%/}/"
					;;
				*/*)
					OUTPUT_DIR="${CONFIG_DIR%/}/${OUTPUT_DIR%/}/"
					;;
				*)
					OUTPUT_DIR="${CONFIG_DIR%/}/${OUTPUT_DIR%/}/"
					;;
			esac
		fi
		CONFIG_PATH="${CONFIG_DIR%/}/$(basename "$_config_file")"
		CONFIG_OUTPUT=$(check_configfile "$CONFIG_PATH")
	fi
}

_cleanup_output_dir() {
	# Never delete when debugging or when OUTPUT_DIR is empty/unsafe.
	if [ "${SHTRACER_DEBUG}" = 'true' ]; then
		return 0
	fi
	if [ -z "${OUTPUT_DIR}" ]; then
		return 0
	fi
	case "${OUTPUT_DIR}" in
		"/" | "")
			return 0
			;;
		*/output | */output/)
			: # ok
			;;
		*/shtracer_output|*/shtracer_output/)
			: # ok
			;;
		*)
			# Safety: only delete known output dir names.
			return 0
			;;
	esac
	rm -rf -- "${OUTPUT_DIR}" >/dev/null 2>&1 || true
}

_install_cleanup_traps() {
	# Install once per process.
	if [ "${_SHTRACER_TRAPS_INSTALLED:-}" = 'true' ]; then
		return 0
	fi
	_SHTRACER_TRAPS_INSTALLED='true'

	trap '_cleanup_output_dir' EXIT
	trap 'trap - EXIT; _cleanup_output_dir; exit 130' INT
	trap 'trap - EXIT; _cleanup_output_dir; exit 143' TERM
	trap 'trap - EXIT; _cleanup_output_dir; exit 129' HUP
	trap 'trap - EXIT; _cleanup_output_dir; exit 131' QUIT

	# Optional test hook: delay after traps are installed.
	# (Used only by tests to reliably send SIGINT.)
	if [ -n "${SHTRACER_TEST_HOLD_SECS:-}" ]; then
		case "${SHTRACER_TEST_HOLD_SECS}" in
			*[!0-9]* | '') : ;;
			*)
				sleep "${SHTRACER_TEST_HOLD_SECS}" || true
				;;
		esac
	fi
}

##
# @brief  Main routine
# @tag    @IMP1.4@ (FROM: @ARC1.1@)
main_routine() {

	load_functions
	init_environment
	parse_arguments "$@"

	# Ensure output directory exists early in the process (normal/verify modes).
	if [ -n "${OUTPUT_DIR:-}" ] && [ "$SHTRACER_MODE" != 'CHANGE' ] && [ "$SHTRACER_MODE" != 'TEST' ]; then
		mkdir -p -- "${OUTPUT_DIR}" >/dev/null 2>&1 || true
	fi

	# Export mode for use in sub-functions
	export SHTRACER_MODE
	export EXPORT_JSON
	export EXPORT_SUMMARY
	export EXPORT_HTML
	export SHTRACER_DEBUG

	# Install cleanup traps after OUTPUT_DIR is resolved.
	if [ "$SHTRACER_MODE" != 'TEST' ]; then
		_install_cleanup_traps
	fi

	# Tag change mode
	if [ "$SHTRACER_MODE" = 'CHANGE' ]; then
		swap_tags "$CONFIG_OUTPUT" "$BEFORE_TAG" "$AFTER_TAG"
		_cleanup_output_dir
		return 0

	# Test mode
	elif [ "$SHTRACER_MODE" = 'TEST' ]; then
		sh -c "cd ${SCRIPT_DIR%/}/scripts/test/; ./shtracer_unittest.sh"
		return 0
	fi

	# Normal mode or Verify mode
	if ! _TAGS=$(extract_tags "$CONFIG_OUTPUT"); then
		error_exit 1 "main_routine" "Error in extract_tags"
	fi
	if ! _TAG_TABLE_FILENAMES=$(make_tag_table "$_TAGS"); then
		error_exit 1 "main_routine" "Error in make_tag_table"
	fi

	_TAG_TABLE_FILENAME=${_TAG_TABLE_FILENAMES%%"$SHTRACER_SEPARATOR"*}
	_VERIFICATION_FILENAME=${_TAG_TABLE_FILENAMES#*"$SHTRACER_SEPARATOR"}

	if [ "$SHTRACER_MODE" = 'NORMAL' ]; then
		# If --summary flag is specified, print summary to stdout and exit
		if [ "$EXPORT_SUMMARY" = 'true' ]; then
			_TAG_OUTPUT_DIR="${OUTPUT_DIR%/}/tags/"
			print_summary_direct_links "$_TAGS" "${_TAG_OUTPUT_DIR%/}/02_tag_pairs"
			_cleanup_output_dir
			return 0
		fi

		# Generate JSON (now mandatory for visualization)
		_TAG_OUTPUT_DIR="${OUTPUT_DIR%/}/tags/"
		_CONFIG_OUTPUT_DIR="${OUTPUT_DIR%/}/config/"
		if ! _JSON_OUTPUT_FILE=$(make_json \
			"$_TAGS" \
			"${_TAG_OUTPUT_DIR%/}/02_tag_pairs" \
			"${_TAG_OUTPUT_DIR%/}/03_tag_pairs_downstream" \
			"$_TAG_TABLE_FILENAME" \
			"${_CONFIG_OUTPUT_DIR%/}/01_config_table" \
			"$CONFIG_PATH"); then
			error_exit 1 "main_routine" "Error in make_json"
		fi

		# If --json flag is specified, output JSON to stdout and exit
		if [ "$EXPORT_JSON" = 'true' ]; then
			cat "$_JSON_OUTPUT_FILE"
			_cleanup_output_dir
			return 0
		fi

		# If --html flag is specified, generate HTML to stdout via viewer and exit
		if [ "$EXPORT_HTML" = 'true' ]; then
			if [ ! -r "${SCRIPT_DIR%/}/scripts/main/shtracer_viewer.sh" ]; then
				error_exit 1 "main_routine" "Viewer script not found: ${SCRIPT_DIR%/}/scripts/main/shtracer_viewer.sh"
			fi
			sh "${SCRIPT_DIR%/}/scripts/main/shtracer_viewer.sh" <"$_JSON_OUTPUT_FILE"
			_exit_code=$?
			_cleanup_output_dir
			return "$_exit_code"
		fi
	fi

	if print_verification_result "$_VERIFICATION_FILENAME"; then
		if [ "$SHTRACER_MODE" = 'VERIFY' ]; then
			:
		else
			cat "$_TAG_TABLE_FILENAME"
		fi
	fi

	_cleanup_output_dir
}

case "$0" in
	*shtracer)
		main_routine "$@"
		;;
	*)
		:
		;;
esac
