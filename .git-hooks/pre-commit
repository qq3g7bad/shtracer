#!/bin/sh
#
# Pre-commit hook for shtracer project
# This hook runs shellcheck and shfmt on staged shell script files
#
# To enable this hook:
#   ln -sf ../../.git-hooks/pre-commit .git/hooks/pre-commit
#
# To bypass this hook (not recommended):
#   git commit --no-verify

set -e

echo "Running pre-commit checks..."

# Get list of staged shell script files (exclude shunit2 submodule)
STAGED_SH_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh)$|^shtracer$' | grep -v 'shunit2/' || true)

if [ -z "$STAGED_SH_FILES" ]; then
  echo "No shell script files to check."
  exit 0
fi

# Check if shellcheck is installed
if ! command -v shellcheck >/dev/null 2>&1; then
  echo "Warning: shellcheck is not installed. Skipping shellcheck."
else
  echo "Running shellcheck..."
  for file in $STAGED_SH_FILES; do
    if [ -f "$file" ]; then
      echo "  Checking $file"
      shellcheck "$file" || {
        echo "Shellcheck failed for $file"
        echo "Please fix the issues above or use 'git commit --no-verify' to bypass."
        exit 1
      }
    fi
  done
  echo "Shellcheck passed!"
fi

# Check if shfmt is installed (prefer local tools/shfmt 3.8.0)
SHFMT_CMD=""
if [ -x "./tools/shfmt" ]; then
  SHFMT_CMD="./tools/shfmt"
  echo "Using local shfmt: $(./tools/shfmt --version)"
elif command -v shfmt >/dev/null 2>&1; then
  SHFMT_CMD="shfmt"
  echo "Using system shfmt: $(shfmt --version)"
else
  echo "Warning: shfmt is not installed. Skipping formatting check."
  echo "Install shfmt v3.8.0 to tools/: wget -qO tools/shfmt https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64 && chmod +x tools/shfmt"
fi

if [ -n "$SHFMT_CMD" ]; then
  echo "Checking formatting with shfmt..."
  for file in $STAGED_SH_FILES; do
    if [ -f "$file" ]; then
      echo "  Checking $file"
      if ! $SHFMT_CMD -d -ci -bn "$file" >/dev/null 2>&1; then
        echo "Formatting issues found in $file"
        echo "Run '$SHFMT_CMD -w -ci -bn $file' to fix."
        echo "Or use 'git commit --no-verify' to bypass."
        exit 1
      fi
    fi
  done
  echo "Formatting check passed!"
fi

echo "All pre-commit checks passed!"
exit 0
